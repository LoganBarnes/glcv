language: c++

branches:
  only:
    - master

dist: trusty

matrix:
#  include:
#    - os: linux
#      addons:
#        apt:
#          sources:
#            - ubuntu-toolchain-r-test
#          packages:
#            - g++-7
#            - mesa-utils
#            - xorg-dev
#            - libx11-xcb-dev
#            - libxkbcommon-dev
#            - libmirclient-dev
#            - libwayland-dev
#            - libxrandr-dev
#            - lcov
#      env:
#        - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"

    - os: osx
      osx_image: xcode8
      env:
        - MATRIX_EVAL="CC=clang && CXX=clang++"

before_install:
  - eval "${MATRIX_EVAL}"

  ############################################################################
  # Update OS X homebrew
  ############################################################################
  - |
    if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then
      brew update
    fi

install:
  ############################################################################
  # All compiled dependencies are installed in ${TRAVIS_BUILD_DIR}/deps/
  ############################################################################
  - DEPS_DIR="${TRAVIS_BUILD_DIR}/deps"
  - mkdir -p ${DEPS_DIR}

  ############################################################################
  # Install a recent CMake
  ############################################################################
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      . ${TRAVIS_BUILD_DIR}/.ci/download_cmake.sh ${DEPS_DIR}
    else
      brew outdated cmake || brew upgrade cmake
    fi
  - cmake --version

  ############################################################################
  # Install the Vulkan SDK
  ############################################################################
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      . ${TRAVIS_BUILD_DIR}/.ci/download_vulkan.sh ${DEPS_DIR}
    fi

script:
  ############################################################################
  # Build project and run CPU based tests
  ############################################################################
  - cd ${TRAVIS_BUILD_DIR}
  - mkdir cmake-build-debug
  - cd cmake-build-debug
  - |
   cmake \
   -DCMAKE_BUILD_TYPE=Debug \
   -DGLCV_BUILD_TESTS=ON \
   -DGLCV_BUILD_EXAMPLES=ON \
   -DGLCV_USE_DEV_FLAGS=ON \
   -DGLCV_HEADLESS=ON \
   ..
  - make -j

  - cd ${TRAVIS_BUILD_DIR}
  - mkdir cmake-build-release
  - cd cmake-build-release
  - |
   cmake \
   -DCMAKE_BUILD_TYPE=Release \
   -DGLCV_BUILD_TESTS=ON \
   -DGLCV_BUILD_EXAMPLES=ON \
   -DGLCV_USE_DEV_FLAGS=ON \
   -DGLCV_HEADLESS=ON \
   ..
  - make -j

notifications:
  on_success: never
  on_failure: always
